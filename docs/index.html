<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Oswald|Roboto+Condensed:700" rel="stylesheet">
    <script type="text/javascript" src="./bundles/index.js"></script>
</head>
<body>

    <h1>Pillow performance</h1>

    <section>
        <h2 id="resampling">Resampling</h2>

        <p>
            Image resampling is one of the most common processing operations.
            Good resampling can be achieved with
            <a href="http://www.imagemagick.org/Usage/filter/#filter">
                convolution-based</a> method.
        </p>
        <p>
            "Convolution" means that for each pixel of the final image
            we compute some area ("window")
            from the source image using weights.
            Size of the area and weights values depend on choosen filter.
            There are many filters.
            This is most common:
        </p>
        <ul>
            <li><code>Bilinear</code> — higly-efficient filter
                with small window and blurry result;</li>
            <li><code>Bicubic</code> — high-quality filter with medium window;</li>
            <li><code>Lanczos</code> — allows trade a quality over performance
                in some cases.</li>
        </ul>   
        <p>
            Also, when we downscaling the image,
            we need to increase the window size
            to do not loose the original image pixels.
            Unfortunately, not all libraries and software do this.
            As a result, output images can look extra sharp and crisp.
            In some cases the result can
            only vaguely reminiscent of the original.
        </p>
        <p>
            This is results of resizing
            <a href="https://unsplash.com/photos/h0N_2iZMA_4" target="_blank">
                4912 × 7360 image</a> to 150 × 225 px
            using different software and different filters.
            Google Сhome's <code>&lt;canvas&gt;</code> implementation
            doesn't increase the window size on downscaling.
            OpenCV also doesn't do this using
            <code>Bicubic</code> filter,
            but offers supersampling.
        </p>
        <!-- TODO: Add Intel Performance Primitives -->
        <div class="samples">
            <figure>
                <img src="./static/bridge_chrome.png" alt="Google Chrome" width="150" />
                <figcaption>Google Chrome canvas</figcaption>
            </figure>
            <figure>
                <img src="./static/bridge_cv2_cubic.png" alt="CV2 Cubic" width="150" />
                <figcaption>CV2 Cubic</figcaption>
            </figure>
            <figure>
                <img src="./static/bridge_cv2_area.png" alt="CV2 Area" width="150" />
                <figcaption>CV2 Area (supersampling)</figcaption>
            </figure>
        </div>
        <p>
            Obviously, this is meaningless to compare OpenCV
            <code>Bicubic</code> performance
            with correct convolution implementations.
            Also, supersampling is different resampling method,
            not based on convolutions.
            It is correct for downscaling
            but unacceptable for upscaling.
        </p>
        <p>
            From the very begining 
            <a href="#library-pil">PIL</a>
            also didn't increase the window size
            for <code>Bilinear</code> and <code>Bicubic</code> filters,
            while did for <code>Antialias</code>
            (the real name of the filter is
            <a href="https://en.wikipedia.org/wiki/Lanczos_algorithm">
                Lanczos</a>).
            In Pillow <code>2.7.0</code> this was fixed.
        </p>
        <div class="samples">
            <figure>
                <img src="./static/bridge_pil_bicubic.png" alt="PIL Bicubic" width="150" />
                <figcaption>PIL Bicubic</figcaption>
            </figure>
            <figure>
                <img src="./static/bridge_pil_lanczos.png" alt="PIL Lanczos" width="150" />
                <figcaption>PIL Antialias (Lanczos)</figcaption>
            </figure>
            <figure>
                <img src="./static/bridge_pillow_bicubic.png" alt="Pillow Bicubic" width="150" />
                <figcaption>Pillow Bicubic</figcaption>
            </figure>
        </div>
        <p>
            On the other hand, some image libraries do convolutions right.
            For example, <a href="#library-imagemagick">ImageMagick</a>.
            The problem with ImageMagick that resampling is very slow.
            For example it about 20x slower than
            <a href="#library-skia">Skia</a>
            which can also do high-quality convolution resampling.
        </p>
        <p>
            From the very begining PIL and Pillow resampling
            performance used to be quite low
            and comparable to ImageMagick.
            Pillow 2.7 reverse the trend
            introducing several common optimizations
            such as loops rearrangement,
            and cache-aware transposition.
        </p>
        <div class="chart">
            <canvas id="chart-resample-scalar" width="1100" height="400"></canvas>
            <script type="text/javascript">
                partialCompetition(
                    document.getElementById("chart-resample-scalar"),
                    'resample-4k-rgb',
                    [
                        "imagemagick-6.8.9",
                        "pillow-2.0",
                        "pillow-2.7",
                        "pillow-3.4"
                    ]
                );
            </script>
        </div>
        <p>
            Charts show median time (lower is better)
            required for resizing source 2560x1600 RGB image
            to one of the four destination sizes
            using one of the filters.
            For significat downsampling Pillow 2.7 faster than PIL
            in <b>4 — 5.5 times</b>.
            Pillow 3.3 instroduces fixed-point arithmetic
            for resampling which is much faster.
            Pillow 3.4 has additional optimizations
            for large target dimensions.
            In the end current Pillow version
            <b>up to 9 times</b> faster than original PIL.
        </p>
        <p>
            But this is not the end of the story.
            Starting from Pillow 3.2 you can use
            <a href="#library-pillow-simd">SIMD-enabled Pillow version</a>.
            Pillow SIMD resampling performance is increasing
            along with basic Pillow version.
            The latest Pillow SIMD compiled with AVX2
            is <b>3.5 — 4.5 times</b> faster than basic Pillow.
            In sum, Pillow SIMD resampling performance
            <b>20 — 40 times</b> higher than original PIL.
        </p>
        <div class="chart">
            <canvas id="chart-resample-simd" width="1100" height="400"></canvas>
            <script type="text/javascript">
                partialCompetition(
                    document.getElementById("chart-resample-simd"),
                    'resample-4k-rgb',
                    [
                        "pillow-3.4",
                        "pillow-simd-3.4-sse4",
                        "pillow-simd-3.4-avx2"
                    ]
                );
            </script>
        </div>
    </section>

    <section>
        <h2 id="blur">Blur</h2>
        <p>
            High-quality
            <a href="https://en.wikipedia.org/wiki/Gaussian_blur">
                gaussian blur</a>.
        </p>

        <p>
            Starting from Pillow 2.7 the Gaussian blur implementation is 
            based on the
            <a href="http://www.mia.uni-saarland.de/Publications/gwosdek-ssvm11.pdf">
                Mathematical Image Analysis Group work</a>
            and operates in constant time related to blur radius.
        </p>
    </section>

    <section>
        <h2 id="libraries">Libraries</h2>

        <dl class="libraries">
            <dt id="library-pil">PIL</dt>
            <dd>
                Python image library. Was initialy released for Python 1.2 in 1995.
                Last version is 1.1.7 was released on November 15, 2009.
                Includes image codecs and image manipulation routines.
            </dd>

            <dt id="library-pillow">Pillow</dt>
            <dd>
                PIL fork. Originally was designed to simplify installation
                in the modern environment. Starting from version 2.0 (2013)
                supports Python 3 and is actively maintained and developed.
                <a href="https://pillow.readthedocs.io/en/3.4.x/">
                    docs</a>
            </dd>

            <dt id="library-pillow-simd">Pillow SIMD</dt>
            <dd>
                Highly optimized "following" Pillow fork with speedups
                for some common operations using SIMD inctructions.
                <a href="https://github.com/uploadcare/pillow-simd#pillow-simd">
                    readme</a>
            </dd>
            
            <dt id="library-imagemagick">ImageMagick</dt>
            <dd>
                Very popular image manipulation library with many bindings
                for different languages. Extremely flexible.
                <a href="http://www.imagemagick.org/">
                    homepage</a>
            </dd>

            <dt id="library-skia">Skia</dt>
            <dd>
                Highly efficient 2D graphics library. It serves as the graphics
                engine for Chrome and Chrome OS, Android, Firefox and Firefox OS.
                <a href="https://skia.org">homepage</a>
            </dd>
        </dl>
    </section>

    <div class="selects-grid">
        <div class="selects-grid__inner">
            <div class="selects-grid__cell">
                <h4>System</h4>
                <ul class="select -large" id="select-system"></ul>
                <p class="info"></p>
            </div>

            <div class="selects-grid__cell">
                <h4>Chart set</h4>
                <ul class="select" id="select-preset"></ul>
            </div>
        </div>

        <div class="selects-grid__cell">
            <h4>Competition</h4>
            <ul class="select -large" id="select-competition"></ul>
        </div>
    </div>

    <canvas id="chart-container" width="1100" height="400"></canvas>

</body>
</html>
